<!DOCTYPE html>
<html>
<head>
    <title>ProjectFlow Task Notifications Test</title>
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .notification {
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }

        .task-created {
            border-left-color: #28a745;
        }

        .task-updated {
            border-left-color: #ffc107;
        }

        .task-deleted {
            border-left-color: #dc3545;
        }

        input, button {
            padding: 8px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>ProjectFlow Task Notifications Test</h1>

    <div>
        <label>Project ID to monitor:</label>
        <input type="number" id="projectId" value="1" />
        <button onclick="joinProject()">Join Project Group</button>
        <button onclick="leaveProject()">Leave Project Group</button>
    </div>

    <div id="status">Disconnected</div>
    <div id="notifications"></div>

    <script>
        let connection = null;
        let currentProjectId = null;

        // Initialize connection
        function initConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/hubs/task-updates")
                .configureLogging(signalR.LogLevel.Information)
                .build();

            // Connection events
            connection.start().then(function () {
                document.getElementById('status').textContent = 'Connected to TaskUpdatesHub';
                console.log('Connected to TaskUpdatesHub');

            }).catch(function (err) {
                document.getElementById('status').textContent = 'Connection failed';
                console.error('Connection error:', err);
            });

            connection.onclose(function() {
                document.getElementById('status').textContent = 'Disconnected';
            });

            // Listen for notifications
            connection.on("TaskCreated", function (task) {
                console.log("TaskCreated received:", task);
                addNotification(`Task Created: "${task.title}" (ID: ${task.taskId})`, 'task-created');
            });

            connection.on("TaskUpdated", function (task) {
                addNotification(`Task Updated: "${task.title}" - Status: ${task.status} (ID: ${task.taskId})`, 'task-updated');
            });

            connection.on("TaskDeleted", function (data) {
                addNotification(`Task Deleted: ID ${data.taskId} from Project ${data.projectId}`, 'task-deleted');
            });

            connection.on("ProjectUpdated", function (project) {
                addNotification(`Project Updated: "${project.name}" - Status: ${project.status}`, 'task-updated');
            });
        }

        function joinProject() {
            if (!connection) return;

            const projectId = document.getElementById('projectId').value;
            if (!projectId) return;

            connection.invoke("JoinProjectGroup", projectId)
                .then(() => {
                    currentProjectId = projectId;
                    document.getElementById('status').textContent = `Connected - Monitoring Project ${projectId}`;
                    addNotification(`Joined project group ${projectId}`, '');
                })
                .catch(err => console.error('Error joining group:', err));
        }

        function leaveProject() {
            if (!connection || !currentProjectId) return;

            connection.invoke("LeaveProjectGroup", currentProjectId)
                .then(() => {
                    addNotification(`Left project group ${currentProjectId}`, '');
                    currentProjectId = null;
                    document.getElementById('status').textContent = 'Connected - Not monitoring any project';
                })
                .catch(err => console.error('Error leaving group:', err));
        }

        function addNotification(message, cssClass) {
            const div = document.createElement("div");
            div.className = `notification ${cssClass}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;

            const container = document.getElementById("notifications");
            container.insertBefore(div, container.firstChild);
        }

        // Initialize when page loads
        initConnection();
    </script>
</body>
</html>